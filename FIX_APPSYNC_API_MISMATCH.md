# Fix: AppSync API Mismatch Between Frontend and Backend

## Problem Identified

Your frontend is using a **different AppSync API** than your backend deploys to:

- **Frontend is using:** `klp7rzjva5c2bef2zjaygpod44` (API 2)
- **Backend deploys to:** `ukoh7tgmwjbjdhnuirxugqx4ci` (API 3)

This causes:
- Schema changes (like `listBookingRequestsForCompany`) not appearing in the frontend
- Booking portal updates not working
- Data inconsistencies

## Root Cause

The frontend had a **hardcoded API URL** in `src/main.tsx` that forced it to use API 2, while the backend build (`ampx pipeline-deploy`) creates/updates API 3.

## Fix Applied

✅ **Removed hardcoded API URL** from `src/main.tsx`
- The frontend will now use whatever API is specified in `amplify_outputs.json`
- This file is generated by the backend build and should point to API 3

## Next Steps: Verify and Configure

### Step 1: Verify Which API Your Backend Actually Uses

1. **Check CloudFormation Stack:**
   - Go to **AWS CloudFormation** → Stacks
   - Find your backend stack (e.g., `amplify-d1wxo3x0z5r1oq-main-branch-{hash}`)
   - Click **Resources** tab
   - Find resource type `AWS::AppSync::GraphQLApi`
   - The **Physical ID** is the API ID

2. **Check Lambda Environment:**
   - Go to **AWS Lambda** → `publicBooking` function
   - **Configuration** → **Environment variables**
   - Check `AMPLIFY_DATA_GRAPHQL_ENDPOINT`
   - Extract the API ID from the URL

**Expected:** Both should show `ukoh7tgmwjbjdhnuirxugqx4ci` (API 3)

### Step 2: Verify API 3 Has Cognito User Pool Auth

**Critical:** The frontend needs Cognito User Pool authentication. API 3's primary auth is `API_KEY`, but it must also have Cognito enabled.

1. Go to **AWS AppSync** → APIs
2. Click on API 3 (`ukoh7tgmwjbjdhnuirxugqx4ci`)
3. Go to **Settings** tab
4. Check **Authorization modes** section
5. Verify:
   - ✅ **Amazon Cognito User Pool** is listed and enabled
   - ✅ **AWS IAM** is listed and enabled (for Lambda)
   - ⚠️ **API Key** can be primary, but Cognito must be enabled

**If Cognito is NOT enabled on API 3:**
- You have two options (see Step 3)

### Step 3: Choose Your Approach

#### Option A: Enable Cognito on API 3 (Recommended)

If API 3 doesn't have Cognito enabled:

1. In AppSync Console → API 3 → **Settings**
2. Click **Edit** on Authorization modes
3. Add **Amazon Cognito User Pool** as an authorization mode
4. Select your Cognito User Pool (should match your Amplify app)
5. Save

**Then:**
- Redeploy backend: `npx ampx pipeline-deploy` (or push to trigger CI/CD)
- The generated `amplify_outputs.json` will point to API 3
- Frontend will use API 3 with Cognito auth

#### Option B: Make Backend Deploy to API 2 (Alternative)

If you prefer to use API 2 (which already has Cognito):

1. **Check if API 2 has your data:**
   - Go to DynamoDB → Tables
   - Check if tables are named `Company-{API2_ID}-NONE` or `Company-{API3_ID}-NONE`
   - If API 2 has no data, you'd need to migrate

2. **This is more complex** and not recommended unless API 2 already has all your data

### Step 4: Verify Backend Generates Correct amplify_outputs.json

After the backend build completes:

1. **Check the build artifacts:**
   - Go to **AWS Amplify** → Your app → **Build history**
   - Click on latest build
   - Download build artifacts
   - Extract and check `amplify_outputs.json`

2. **Verify the API endpoint:**
   ```json
   {
     "data": {
       "url": "https://ukoh7tgmwjbjdhnuirxugqx4ci.appsync-api.us-east-1.amazonaws.com/graphql",
       "aws_region": "us-east-1",
       "default_authorization_type": "AMAZON_COGNITO_USER_POOLS"
     }
   }
   ```

3. **If it's wrong:**
   - Check that `ampx pipeline-deploy` completed successfully
   - Check that `--outputs-out-dir .` is set correctly in `amplify.yml`
   - Verify the backend stack deployed to the correct API

### Step 5: Test the Fix

After deploying:

1. **Check browser network tab:**
   - Open your deployed app
   - DevTools → Network tab
   - Look for GraphQL requests
   - Should now go to: `https://ukoh7tgmwjbjdhnuirxugqx4ci.appsync-api.us-east-1.amazonaws.com/graphql`

2. **Test booking portal:**
   - Enable booking portal for a company
   - Verify it persists (should work now that frontend/backend use same API)

3. **Test custom query:**
   - Try loading booking requests in Management dashboard
   - Should work if `listBookingRequestsForCompany` exists in API 3

## Understanding Your Three APIs

Based on what you see:

1. **API 1** (`f3dw3v4i2ndnrirlmrlucidzh4`):
   - Endpoint: `qft7xoddfrfp7gslj5t5alhjaa`
   - Primary auth: `AMAZON_COGNITO_USER_POOLS`
   - **Status:** Possibly from local/development environment

2. **API 2** (`rrohmt3z6bai3nwm4lqaffp`):
   - Endpoint: `klp7rzjva5c2bef2zjaygpod44`
   - Primary auth: `AMAZON_COGNITO_USER_POOLS`
   - **Status:** What frontend was hardcoded to use (now fixed)

3. **API 3** (`ukoh7tgmwjbjdhnuirxugqx4ci`):
   - Endpoint: `ucwy5mmmyrh2rjz6hhkolzwnke`
   - Primary auth: `API_KEY`
   - **Status:** What backend deploys to (should be the correct one)

## Cleanup (Optional)

Once everything works with API 3:

1. **Delete unused APIs** to avoid confusion:
   - API 1 and API 2 (if they're not being used)
   - **Warning:** Only delete if you're 100% sure they're not needed
   - Check CloudFormation stacks first to see which environments they belong to

2. **Update documentation** with the correct API ID

## Verification Checklist

After applying the fix:

- [ ] Removed hardcoded API URL from `src/main.tsx` ✅ (Done)
- [ ] Verified backend deploys to API 3 (`ukoh7tgmwjbjdhnuirxugqx4ci`)
- [ ] Verified API 3 has Cognito User Pool auth enabled
- [ ] Backend build generates `amplify_outputs.json` with API 3 endpoint
- [ ] Frontend uses API 3 (check browser network tab)
- [ ] Booking portal settings persist correctly
- [ ] Custom queries work (e.g., `listBookingRequestsForCompany`)

## If Issues Persist

1. **Check Amplify Console:**
   - Verify backend build phase runs and succeeds
   - Check that `amplify_outputs.json` is generated
   - Verify frontend build uses the generated file

2. **Check AppSync:**
   - Verify API 3 has the latest schema
   - Check that `listBookingRequestsForCompany` exists in API 3
   - Verify authorization modes are correct

3. **Check CloudWatch:**
   - Look for errors in Lambda logs
   - Check if API calls are failing
