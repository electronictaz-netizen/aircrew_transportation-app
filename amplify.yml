version: 1
backend:
  phases:
    build:
      commands:
        - npm install --legacy-peer-deps
        - |
          if [ -z "$AWS_BRANCH" ] || [ -z "$AWS_APP_ID" ]; then
            echo "ERROR: AWS_BRANCH and AWS_APP_ID must be set for pipeline-deploy. Amplify Hosting sets these automatically; if missing, check Build settings or run this in an Amplify build environment."
            echo "AWS_BRANCH is set: $([ -n \"$AWS_BRANCH\" ] && echo 'yes' || echo 'NO')"
            echo "AWS_APP_ID is set: $([ -n \"$AWS_APP_ID\" ] && echo 'yes' || echo 'NO')"
            exit 1
          fi
        - echo "Deploying backend with ampx pipeline-deploy..."
        - echo "AWS_BRANCH=$AWS_BRANCH"
        - echo "AWS_APP_ID=$AWS_APP_ID"
        - |
          npx ampx pipeline-deploy \
            --branch "$AWS_BRANCH" \
            --app-id "$AWS_APP_ID" \
            --outputs-out-dir . \
            --outputs-version "1.4" \
            --outputs-format "json"
        # Check Lambda runtimes after deployment (non-blocking)
        - echo "Checking Lambda function runtimes..."
        - npm run check-lambda || echo "Lambda runtime check completed (warnings may exist)"
frontend:
  phases:
    preBuild:
      commands:
        - npm install --legacy-peer-deps
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
